<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Activity Auto Create</title>
    <link
      href="https://cn.vitejs.dev/logo-with-shadow.png"
      rel="shortcut icon"
      type="image/x-icon"
    />
    <!-- å¯¼å…¥æ ·å¼ -->
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <!-- å¯¼å…¥åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.js"></script>
    <script src="//unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: white;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      .warp {
        width: 600px;
        margin: 0 auto;
        padding: 20px 0;
        animation: fadeInUp 0.8s ease-out;
      }

      .title {
        width: 100%;
        height: 80px;
        line-height: 80px;
        text-align: center;
        font-size: 32px;
        font-weight: 700;
        color: white;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        border: none;
        animation: slideInDown 0.6s ease-out;
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.3);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
      }

      .title::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.8s;
      }

      .title:hover::before {
        left: 100%;
      }

      .action-buttons {
        margin-top: 24px;
        display: flex;
        gap: 12px;
        justify-content: center;
        animation: fadeInUp 1s ease-out 0.3s both;
      }

      .upload-tips {
        font-size: 12px;
        color: #909399;
        padding: 5px 0;
        line-height: 1.4;
      }

      /* è¡¨å•å®¹å™¨æ ·å¼ */
      .form-container {
        background: white;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #e4e7ed;
        animation: fadeInUp 0.8s ease-out 0.2s both;
      }

      /* è¡¨å•é¡¹æ ·å¼ä¼˜åŒ– */
      .el-form-item {
        margin-bottom: 16px;
        transition: all 0.3s ease;
      }

      .el-form-item:hover {
        transform: translateX(4px);
      }

      .el-form-item__label {
        font-weight: 600 !important;
        color: #2c3e50 !important;
        font-size: 14px !important;
      }

      /* è¾“å…¥æ¡†æ ·å¼ä¼˜åŒ– - è§£å†³åŒå±‚è¾¹æ¡†é—®é¢˜ */
      .el-input {
        border-radius: 8px !important;
        border: 1px solid #dcdfe6 !important;
        transition: all 0.3s ease !important;
        background: white !important;
      }

      .el-input:hover {
        border-color: #c0c4cc !important;
      }

      .el-input.is-focus {
        border-color: #409eff !important;
        box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1) !important;
      }

      .el-input__inner {
        border: none !important;
        background: transparent !important;
        padding: 8px 12px !important;
        font-size: 14px !important;
        height: 36px !important;
        line-height: 1.5 !important;
        border-radius: 0 !important;
      }

      .el-input__inner:focus {
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
      }

      .el-input__inner:hover {
        border: none !important;
      }

      /* å•é€‰æŒ‰é’®æ ·å¼ä¼˜åŒ– - è§£å†³åŒå±‚è¾¹æ¡†é—®é¢˜ */
      .el-radio-button {
        margin-right: 8px !important;
      }

      .el-radio-button__inner {
        border-radius: 6px !important;
        border: 1px solid #dcdfe6 !important;
        transition: all 0.3s ease !important;
        padding: 6px 12px !important;
        font-weight: 500 !important;
        height: 36px !important;
        line-height: 1.5 !important;
        background: white !important;
        color: #606266 !important;
      }

      .el-radio-button__inner:hover {
        transform: none;
        border-color: #c0c4cc !important;
        color: #409eff !important;
      }

      .el-radio-button__original-radio:checked + .el-radio-button__inner {
        background: linear-gradient(135deg, #409eff, #36a3f7) !important;
        border-color: #409eff !important;
        color: white !important;
        box-shadow: 0 2px 8px rgba(64, 158, 255, 0.3) !important;
      }

      /* å•é€‰æŒ‰é’®ç»„æ ·å¼ */
      .el-radio-group {
        display: flex !important;
        gap: 8px !important;
      }

      .el-radio-button__original-radio:checked + .el-radio-button__inner {
        background: linear-gradient(135deg, #409eff, #36a3f7) !important;
        border-color: #409eff !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
      }

      .el-button {
        border-radius: 8px !important;
        padding: 8px 16px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        border: none !important;
        position: relative !important;
        overflow: hidden !important;
        height: 36px !important;
        font-size: 14px !important;
      }

      .el-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .el-button:hover::before {
        left: 100%;
      }

      .el-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .el-button--primary {
        background: linear-gradient(135deg, #409eff, #36a3f7) !important;
        box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3) !important;
      }

      .el-button--success {
        background: linear-gradient(135deg, #67c23a, #85ce61) !important;
        box-shadow: 0 4px 15px rgba(103, 194, 58, 0.3) !important;
      }

      .el-button--warning {
        background: linear-gradient(135deg, #e6a23c, #f0c78a) !important;
        box-shadow: 0 4px 15px rgba(230, 162, 60, 0.3) !important;
      }

      /* åŠ¨ç”»å®šä¹‰ */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(30px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* åŠ è½½åŠ¨ç”» */
      .loading-pulse {
        animation: pulse 2s infinite;
      }

      /* æ‚¬æµ®å·¥ä½œæµç¨‹æ ·å¼ */
      .floating-workflow {
        position: fixed;
        top: 80px;
        right: 60px;
        width: 380px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        z-index: 9999;
        animation: slideInRight 0.8s ease-out 0.5s both;
      }

      .workflow-panel {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        border: 1px solid #e4e7ed;
        overflow: hidden;
      }

      .workflow-header {
        background: linear-gradient(135deg, #409eff, #36a3f7);
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        font-weight: 600;
        color: white;
        font-size: 13px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .workflow-content {
        padding: 16px;
      }

      .workflow-steps {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .step {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e4e7ed;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .step::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #409eff, #36a3f7);
        border-radius: 0 2px 2px 0;
      }

      .step:hover {
        transform: translateX(8px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border-color: #409eff;
        background: white;
      }

      .step-number {
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, #409eff, #36a3f7);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 12px;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
        transition: all 0.3s ease;
      }

      .step:hover .step-number {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(64, 158, 255, 0.4);
      }

      .step-content {
        flex: 1;
      }

      .step-title {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 4px;
        font-size: 13px;
        transition: color 0.3s ease;
      }

      .step:hover .step-title {
        color: #409eff;
      }

      .step-desc {
        color: #606266;
        font-size: 11px;
        line-height: 1.4;
      }

      .workflow-note {
        margin-top: 16px;
        padding: 12px;
        background: #fff7e6;
        border: 1px solid #ffd591;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #d46b08;
        font-size: 11px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(212, 107, 8, 0.1);
        transition: all 0.3s ease;
      }

      .workflow-note:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212, 107, 8, 0.15);
        background: white;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1400px) {
        .floating-workflow {
          right: 40px;
          width: 340px;
        }
      }

      @media (max-width: 1200px) {
        .floating-workflow {
          display: none;
        }
        .warp {
          margin-right: auto;
        }
      }

      @media (max-width: 768px) {
        .warp {
          width: 95%;
          padding: 20px 0;
        }

        .title {
          font-size: 28px;
          height: 80px;
          line-height: 80px;
          margin-bottom: 20px;
        }

        .form-container {
          padding: 20px;
        }

        .action-buttons {
          flex-direction: column;
          align-items: center;
        }

        .el-button {
          width: 100%;
          max-width: 300px;
        }

        .floating-workflow {
          display: none;
        }
      }

      /* æ–‡æ¡ˆä¸Šä¼ è¯´æ˜æ ·å¼ */
      .workflow-upload {
        margin-top: 16px;
        padding: 12px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        transition: all 0.3s ease;
      }

      .workflow-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15);
        background: white;
      }

      .upload-title {
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 10px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .upload-methods {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .upload-method {
        padding: 10px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e0e7ff;
        transition: all 0.3s ease;
      }

      .upload-method:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
      }

      .method-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
        font-size: 11px;
      }

      .method-desc {
        color: #6b7280;
        font-size: 10px;
        line-height: 1.3;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="warp">
        <div class="title">Activity Auto Create Form</div>
        <div class="form-container">
          <el-form :model="form" label-width="140px">
            <el-form-item label="Project Name">
              <el-radio-group v-model="form.projectName">
                <el-radio-button label="Yoho"></el-radio-button>
                <el-radio-button label="Hiyoo"></el-radio-button>
                <el-radio-button label="SoulStar"></el-radio-button>
              </el-radio-group>
            </el-form-item>
            <el-form-item label="General activity">
              <el-radio-group v-model="form.isGeneral">
                <el-radio-button label="true"></el-radio-button>
                <el-radio-button label="false"></el-radio-button>
              </el-radio-group>
            </el-form-item>
            <el-form-item label="Activity catalog">
              <el-input v-model="form.catalog" />
            </el-form-item>
            <el-form-item label="Activity Name">
              <el-input v-model="form.name" />
            </el-form-item>
            <el-form-item label="Activity id">
              <el-input v-model="form.id" />
            </el-form-item>
            <el-form-item
              label="Document url"
              style="display: flex; align-items: center"
            >
              <div style="width: 225px; margin-right: 10px">
                <el-input v-model="form.url" placeholder="è¯·è¾“å…¥éœ€æ±‚æ–‡æ¡£é“¾æ¥" />
              </div>
              <el-button type="primary" @click="openProjectDoc"
                >âœˆï¸âœˆï¸âœˆï¸ éœ€æ±‚æ–‡æ¡£</el-button
              >
            </el-form-item>
            <el-form-item
              label="Upload Text"
              v-if="form.projectName != 'SoulStar'"
            >
              <el-radio-group v-model="form.uploadType">
                <el-radio value="text">æ–‡æ¡ˆé“¾æ¥ä¸Šä¼ </el-radio>
                <el-radio value="excel">æœ¬åœ° Excel ä¸Šä¼ </el-radio>
              </el-radio-group>
            </el-form-item>
            <el-form-item
              label=""
              v-if="form.projectName != 'SoulStar' && form.uploadType === 'text'"
            >
              <div style="display: flex; align-items: center; gap: 10px">
                <div style="width: 225px">
                  <el-input
                    v-model="form.textUrl"
                    placeholder="è¯·è¾“å…¥æ–‡æ¡ˆé“¾æ¥"
                  />
                </div>
                <el-button
                  type="primary"
                  @click="handleFileChange"
                  :loading="uploadLoading"
                  :disabled="!form.id || !form.textUrl"
                  v-loading.fullscreen.lock="form.fullscreenLoadingToText"
                >
                  {{ uploadLoading ? 'ä¸Šä¼ ä¸­...' : `ä¸Šä¼ ` }}
                </el-button>
              </div>
            </el-form-item>
            <el-form-item
              label=""
              v-if="form.projectName != 'SoulStar' && form.uploadType === 'excel'"
            >
              <el-button type="success" @click="handleFileChangeExcel"
                >Excel è¡¨æ ¼ä¸Šä¼ </el-button
              >
            </el-form-item>
            <el-form-item label="Activity Figma">
              <el-input v-model="form.figma" />
            </el-form-item>
            <el-form-item label="Background-color">
              <el-input v-model="form.bgc" />
            </el-form-item>
            <el-form-item label="Swiper op" style="display: flex">
              <el-radio-group v-model="form.op">
                <el-radio-button label="true"></el-radio-button>
                <el-radio-button label="false"></el-radio-button>
              </el-radio-group>
              <el-input
                v-model="form.opNum"
                style="width: 225px; margin-left: 10px"
                placeholder="swiper op num, default 1"
              />
            </el-form-item>
            <el-form-item label="Hot banner">
              <el-radio-group v-model="form.hot">
                <el-radio-button label="true"></el-radio-button>
                <el-radio-button label="false"></el-radio-button>
              </el-radio-group>
            </el-form-item>
          </el-form>
        </div>

        <div class="action-buttons">
          <el-button
            type="primary"
            @click="onSubmit"
            v-loading.fullscreen.lock="form.fullscreenLoading"
          >
            Create {{ form.projectName }} Activity
          </el-button>

          <el-button
            type="success"
            @click="downloadTemplate"
            :loading="downloadLoading"
          >
            {{ downloadLoading ? 'ä¸‹è½½ä¸­...' : 'Down Template' }}
          </el-button>
        </div>
      </div>
      <!-- åå•ä¸Šä¼  -->
      <input
        style="display: none"
        type="file"
        ref="excelInput"
        @change="excelInputChange($event)"
      />
    </div>

    <!-- æ‚¬æµ®å·¥ä½œæµç¨‹è¯´æ˜ -->
    <div class="floating-workflow">
      <div class="workflow-panel">
        <div class="workflow-header">
          <span>ğŸ“‹ å·¥ä½œæµç¨‹è¯´æ˜</span>
        </div>
        <div class="workflow-content">
          <div class="workflow-steps">
            <div class="step">
              <div class="step-number">1</div>
              <div class="step-content">
                <div class="step-title">åˆ›å»º Git åˆ†æ”¯</div>
                <div class="step-desc">
                  è‡ªåŠ¨åˆ›å»ºå¹¶åˆ‡æ¢åˆ°ä»¥æ´»åŠ¨åç§°å‘½åçš„åˆ†æ”¯ï¼ˆå¦‚ï¼štestCreateBranch25ï¼‰
                </div>
              </div>
            </div>
            <div class="step">
              <div class="step-number">2</div>
              <div class="step-content">
                <div class="step-title">ç”Ÿæˆæ´»åŠ¨ä¿¡æ¯</div>
                <div class="step-desc">
                  æ ¹æ®å¡«å†™çš„ä¿¡æ¯ç”Ÿæˆæ´»åŠ¨é“¾æ¥ã€æµ‹è¯•ä¿¡æ¯ç­‰
                </div>
              </div>
            </div>
            <div class="step">
              <div class="step-number">3</div>
              <div class="step-content">
                <div class="step-title">æ‰§è¡Œ Python è„šæœ¬</div>
                <div class="step-desc">
                  è°ƒç”¨åç«¯è„šæœ¬è·å–æ´»åŠ¨æ—¶é—´ã€åœ°åŒºä¿¡æ¯ç­‰
                </div>
              </div>
            </div>
            <div class="step">
              <div class="step-number">4</div>
              <div class="step-content">
                <div class="step-title">åˆ›å»ºæ´»åŠ¨æ–‡ä»¶</div>
                <div class="step-desc">åœ¨å¯¹åº”ç›®å½•ä¸‹åˆ›å»ºå®Œæ•´çš„æ´»åŠ¨é¡µé¢æ–‡ä»¶</div>
              </div>
            </div>
          </div>
          <div class="workflow-note">
            <span>âš ï¸ æ³¨æ„ï¼šåˆ†æ”¯åˆ›å»ºå’Œæ–‡ä»¶åˆ›å»ºå°†å¹¶è¡Œæ‰§è¡Œï¼Œä»¥æé«˜æ•ˆç‡</span>
          </div>
          <div class="workflow-upload">
            <div class="upload-title">ğŸ“ æ–‡æ¡ˆä¸Šä¼ æ–¹å¼</div>
            <div class="upload-methods">
              <div class="upload-method">
                <div class="method-title">æ–¹å¼ä¸€ï¼šè¾“å…¥æ–‡æ¡£æ–‡æ¡ˆé“¾æ¥ä¸Šä¼ </div>
                <div class="method-desc">
                  åœ¨"Upload
                  text1"è¾“å…¥æ¡†ä¸­å¡«å…¥æ–‡æ¡£æ–‡æ¡ˆé“¾é“¾æ¥ï¼Œç‚¹å‡»"é“¾æ¥æ–‡æ¡ˆä¸Šä¼ "æŒ‰é’®è¿›è¡Œä¸Šä¼ ï¼›ï¼ˆä½¿ç”¨
                  python è„šæœ¬ä¸Šä¼ ï¼‰
                </div>
              </div>
              <div class="upload-method">
                <div class="method-title">æ–¹å¼äºŒï¼šä½¿ç”¨Excel è¡¨æ ¼ä¸Šä¼ </div>
                <div class="method-desc">
                  ç‚¹å‡»"excel è¡¨æ ¼ä¸Šä¼ "æŒ‰é’®ï¼Œé€‰æ‹©åŒ…å«æ–‡æ¡ˆå†…å®¹çš„ Excel
                  æ–‡ä»¶è¿›è¡Œæ‰¹é‡ä¸Šä¼ ï¼›ï¼ˆä½¿ç”¨ node æ¥å£è½¬å‘ä¸Šä¼ ï¼‰
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, watch } = Vue;
      const ElementPlus = window.ElementPlus;
      const { ElMessage, ElIcon } = ElementPlus;

      const App = {
        setup() {
          const form = reactive({
            projectName: "Yoho",
            isGeneral: "false",
            catalog: dayjs().format("YYYYMM"),
            branch: "",
            bgc: "",
            name: "",
            id: "",
            url: "",
            textUrl: "",
            figma: "",
            op: "true",
            hot: "true",
            branchCheck: "false", // é»˜è®¤ä¸å¼€å¯åˆ†æ”¯æ£€æµ‹
            info: "", // ææµ‹ä¿¡æ¯
            activityUrl: "", // æ´»åŠ¨é“¾æ¥
            opNum: "",
            fullscreenLoading: false,
            uploadType: "text", // ä¸Šä¼ ç±»å‹ï¼š'text' æˆ– 'excel'
          });

          // æ·»åŠ ä¸Šä¼ åŠ è½½çŠ¶æ€
          const uploadLoading = ref(false);
          // æ·»åŠ ä¸‹è½½æ¨¡æ¿åŠ è½½çŠ¶æ€
          const downloadLoading = ref(false);

          watch(
            () => form.isGeneral,
            () => {
              if (form.isGeneral == "true") {
                form.catalog = "general";
              } else {
                form.catalog = dayjs().format("YYYYMM");
              }
            }
          );

          const setItemWithExpiry = (key, value, expiryInHours) => {
            const now = new Date();

            // è®¡ç®—è¿‡æœŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ + æŒ‡å®šå°æ—¶æ•°ï¼‰
            const expiryTime = now.getTime() + expiryInHours * 60 * 60 * 1000;

            // åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«å€¼å’Œè¿‡æœŸæ—¶é—´
            const item = {
              value: value,
              expiry: expiryTime,
            };

            // å°†å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²å¹¶å­˜å‚¨åˆ° localStorage
            localStorage.setItem(key, JSON.stringify(item));
          };

          const getItemWithExpiry = (key) => {
            console.log("è·å–æ•°æ®:", key);

            const itemStr = localStorage.getItem(key);

            // å¦‚æœé¡¹ç›®ä¸å­˜åœ¨ï¼Œè¿”å› null
            if (!itemStr) {
              return null;
            }

            const item = JSON.parse(itemStr);
            const now = new Date();

            // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦è¶…è¿‡è¿‡æœŸæ—¶é—´
            if (now.getTime() > item.expiry) {
              // å¦‚æœè¿‡æœŸï¼Œåˆ é™¤è¯¥é¡¹å¹¶è¿”å› null
              localStorage.removeItem(key);
              return null;
            }

            console.log("æ•°æ®æœ‰æ•ˆ:", item.value);

            return item.value; // è¿”å›å­˜å‚¨çš„å€¼
          };

          const getInfo = async () => {
            const url = "http://localhost:3000/info";
            try {
              const response = await axios.get(url);
              const { data } = response.data;
              Object.assign(form, data);
              form.name = data.branch;

              // ä½¿ç”¨ç¤ºä¾‹
              const oldForm = getItemWithExpiry("create_activity");
              if (oldForm) {
                console.log("æ•°æ®æœ‰æ•ˆ:", oldForm);
                oldForm &&
                  (form.projectName = oldForm.projectName) &&
                  (form.name = oldForm.name) &&
                  (form.id = oldForm.id) &&
                  (form.url = oldForm.url) &&
                  (form.textUrl = oldForm.textUrl) &&
                  (form.figma = oldForm.figma) &&
                  (form.bgc = oldForm.bgc) &&
                  (form.op = oldForm.op) &&
                  (form.hot = oldForm.hot) &&
                  (form.info = oldForm.info) &&
                  (form.activityUrl = oldForm.activityUrl) &&
                  (form.opNum = oldForm.opNum);
              } else {
                console.log("æ•°æ®å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨");
              }
            } catch (error) {
              console.error("è·å–ä¿¡æ¯å¤±è´¥:", error);
            }
          };

          const handleFileChange = async () => {
            if (!form.id || !form.textUrl || !form.projectName) {
              ElMessage({
                message: "Please enter the projectName, id and textUrl.",
                type: "warning",
              });
              return;
            }

            uploadLoading.value = true;
            try {
              // æ˜¾ç¤ºåˆå§‹æç¤º
              ElMessage({
                message: `å¼€å§‹ä¸Šä¼  ${form.projectName} æ–‡æœ¬...`,
                type: "info",
              });

              const url = "http://localhost:3000/toPythonText";
              const res = await axios.post(url, form);

              // æˆåŠŸæç¤º
              console.log(
                `Congrats, ${
                  res.data.area || form.projectName
                } text have uploaded.`
              );
              ElMessage({
                message: `æˆåŠŸä¸Šä¼  ${form.projectName} æ–‡æœ¬ (${form.id})`,
                type: "success",
                duration: 5000,
              });
            } catch (error) {
              console.error("ä¸Šä¼ æ–‡æœ¬å¤±è´¥:", error);
              ElMessage({
                message: `ä¸Šä¼ æ–‡æœ¬å¤±è´¥: ${error.message || "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"}`,
                type: "error",
                duration: 5000,
              });
            } finally {
              uploadLoading.value = false;
            }
          };

          const handleInfo = () => {
            const map = {
              Yoho: {
                test: "https://activity-h5-test.yoho.media",
                master: "https://activity-h5.yoho.media",
              },
              Hiyoo: {
                test: "https://activity-h5-test.chatchill.media/activity-vite",
                master: "https://activity-h5.chatchill.media/activity-vite",
              },
              SoulStar: {
                test: "https://activity-h5-test.dopalive.com",
                master: "https://activity-h5.dopalive.com",
              },
            };

            const test = `${map[form.projectName].test}/act_v_${form.catalog}_${
              form.name
            }`;
            const master = `${map[form.projectName].master}/act_v_${
              form.catalog
            }_${form.name}`;

            const opTextLinks = [];
            const opMasterLinks = [];
            for (let i = 1; i <= form.opNum; i++) {
              opTextLinks.push(
                `${test}_op${form.opNum == 1 ? "" : i}/index.html?lang=&key=`
              );
              opMasterLinks.push(
                `${master}_op${form.opNum == 1 ? "" : i}/index.html?lang=&key=`
              );
            }

            const text = `ğŸŒ°æ´»åŠ¨ææµ‹: ${form.url}
Figma: ${form.figma}
æ´»åŠ¨ğŸ†”: ${form.id}
æ´»åŠ¨é“¾æ¥(æµ‹è¯•):
${test}/index.html?lang=&key=
${opTextLinks.join("\n")}
${form.hot == "true" ? `${test}_op_hot/index.html?lang=&key=` : "--"}
æ´»åŠ¨é“¾æ¥(æ­£å¼):
${master}/index.html?lang=EG&key=
${opMasterLinks.join("\n")}
${form.hot == "true" ? `${master}_op_hot/index.html?lang=&key=` : "--"}
å‰ç«¯: ${shuffleArray(["@Stone", "@é˜¿ç”°", "@ç„ç­–"])}
åç«¯: ${shuffleArray(["@å­¤ç‹¼", "@å¾…ç»­", "@ç´«çº¢"])}
æµ‹è¯•: ${shuffleArray(["@éš†å¤š", "@ä¿ç½—"])}`;

            form.info = text.replace(/--\n/g, "");
            form.activityUrl = `${master}/index.html?lang=&key=`;
            console.log(form.info);
          };

          const updateBase = () => {
            const data = form;
            const url = "http://localhost:3000/updateBase";
            axios.post(url, data).then((res) => {
              ElMessage({
                message: `success`,
                type: "success",
              });
            });
          };

          // ä¸‹è½½æ¨¡æ¿åˆ°å½“å‰è¿è¡Œç›®å½•
          const downloadTemplate = async () => {
            downloadLoading.value = true;
            try {
              const url = "http://localhost:3000/download-template";
              const res = await axios.post(url, {
                projectName: form.projectName,
              });

              if (res.data.success) {
                ElMessage({
                  message: `æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼ä½ç½®: ${res.data.targetDir}`,
                  type: "success",
                  duration: 5000,
                });
              } else {
                ElMessage({
                  message: `ä¸‹è½½å¤±è´¥: ${res.data.message}`,
                  type: "error",
                });
              }
            } catch (error) {
              console.error("ä¸‹è½½æ¨¡æ¿å¤±è´¥:", error);
              ElMessage({
                message: `ä¸‹è½½å¤±è´¥: ${error.message || "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"}`,
                type: "error",
              });
            } finally {
              downloadLoading.value = false;
            }
          };

          // åˆ›å»ºå¹¶åˆ‡æ¢ git åˆ†æ”¯çš„å‡½æ•°
          const createAndSwitchBranch = async () => {
            // ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æ´»åŠ¨åç§°ä½œä¸ºåˆ†æ”¯å
            const branchName = form.name;

            console.log("Creating and switching to branch:", branchName);

            // è°ƒç”¨åç«¯ API åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯
            const gitUrl = "http://localhost:3000/git-branch";
            const gitData = {
              branchName: branchName,
              projectName: form.projectName,
              branchCheck: form.branchCheck,
            };

            const response = await axios.post(gitUrl, gitData);

            if (response.data.success) {
              ElMessage({
                message: `Successfully created and switched to branch: ${branchName}`,
                type: "success",
              });
              return true; // è¿”å›æˆåŠŸçŠ¶æ€
            } else {
              ElMessage({
                message: `Failed to create branch: ${response.data.message}`,
                type: "error",
              });
              throw new Error(response.data.message); // æŠ›å‡ºé”™è¯¯ï¼Œè®© Promise.allSettled æ•è·
            }
          };

          // åˆ›å»ºæ´»åŠ¨æ–‡ä»¶çš„å‡½æ•°
          const createActivityFile = async () => {
            handleInfo();
            const data = { ...form };
            const url = "http://localhost:3000/submit";
            data.op = data.op == "true" ? "1" : "0";
            data.hot = data.hot == "true" ? "1" : "0";

            console.log("data", data);

            const res = await axios.post(url, data);
            return res;
          };

          const onSubmit = async () => {
            if (!form.url) {
              ElMessage({
                message: `Error, input activity doc.`,
                type: "warning",
              });
              return;
            }
            if (!form.opNum) {
              form.opNum = 1;
            }
            form.fullscreenLoading = true;

            try {
              // å¹¶è¡Œæ‰§è¡Œï¼šåˆ†æ”¯åˆ›å»ºå’Œæ–‡ä»¶åˆ›å»ºåŒæ—¶è¿›è¡Œ
              // createAndSwitchBranch(),
              // const [branchResult, fileResult] = await Promise.allSettled([
              //   ])
              createActivityFile();

              // // å¤„ç†åˆ†æ”¯åˆ›å»ºç»“æœ
              // if (branchResult.status === 'fulfilled') {
              //   console.log('åˆ†æ”¯åˆ›å»ºæˆåŠŸ')
              // } else {
              //   console.error('åˆ†æ”¯åˆ›å»ºå¤±è´¥:', branchResult.reason)
              //   ElMessage({
              //     message: `åˆ†æ”¯åˆ›å»ºå¤±è´¥: ${branchResult.reason.message}`,
              //     type: 'warning'
              //   })
              // }

              ElMessage({
                message: `Congrats, the file has been created.${JSON.stringify(
                  form
                )}`,
                type: "success",
              });
              console.log("JSON.stringify(form)", JSON.stringify(form));
              // ä½¿ç”¨ç¤ºä¾‹
              setItemWithExpiry(`create_activity`, form, 1);
              // å¤„ç†æ–‡ä»¶åˆ›å»ºç»“æœ
              // if (fileResult.status === 'fulfilled') {
              // } else {
              //   console.error('æ–‡ä»¶åˆ›å»ºå¤±è´¥:', fileResult.reason)
              //   ElMessage({
              //     message: `æ–‡ä»¶åˆ›å»ºå¤±è´¥: ${fileResult.reason.message}`,
              //     type: 'error'
              //   })
              // }
            } catch (error) {
              console.error("æäº¤è¿‡ç¨‹ä¸­å‡ºé”™:", error);
              ElMessage({
                message: `æäº¤å¤±è´¥: ${error.message}`,
                type: "error",
              });
            } finally {
              form.fullscreenLoading = false;
            }
          };

          function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; // äº¤æ¢ä½ç½®
            }
            return newArray;
          }

          getInfo();

          // è‡ªæ‰§è¡Œæ–¹æ³•ï¼šæ ¹æ®é¡¹ç›®åç§°è·å–éœ€æ±‚æ–‡æ¡£URL
          const getProjectDocUrl = (() => {
            // éœ€æ±‚æ–‡æ¡£é…ç½®
            const docConfig = [
              {
                label: "yohoéœ€æ±‚æ–‡æ¡£",
                url: "https://micoworld.feishu.cn/wiki/XfKXwiMAFi7XsRk4vh6cM4mWnNf",
              },
              {
                label: "hiyooéœ€æ±‚æ–‡æ¡£",
                url: "https://micoworld.feishu.cn/wiki/LZH8wyvVmi1Q22ktSIdc89FKnAd",
              },
            ];

            // è¿”å›è·å–URLçš„æ–¹æ³•
            return (projectName) => {
              // å°†é¡¹ç›®åç§°è½¬æ¢ä¸ºå°å†™ï¼Œç”¨äºåŒ¹é…
              const projectLower = projectName.toLowerCase();

              // æŸ¥æ‰¾åŒ¹é…çš„æ–‡æ¡£
              const matchedDoc = docConfig.find((doc) => {
                const docLabel = doc.label.toLowerCase();
                // åŒ¹é…é¡¹ç›®åç§°å’Œ"éœ€æ±‚æ–‡æ¡£"å…³é”®è¯ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼Œå¿½ç•¥æœˆä»½ä¿¡æ¯
                return (
                  docLabel.includes(projectLower) &&
                  docLabel.includes("éœ€æ±‚æ–‡æ¡£")
                );
              });

              return matchedDoc ? matchedDoc.url : null;
            };
          })();

          // ç›‘å¬é¡¹ç›®åç§°å˜åŒ–ï¼Œè‡ªåŠ¨å¡«å……æ–‡æ¡£URL
          watch(
            () => form.projectName,
            (newProjectName) => {
              if (newProjectName) {
                const docUrl = getProjectDocUrl(newProjectName);
              }
            },
            { immediate: true }
          );

          // æ‰“å¼€é¡¹ç›®éœ€æ±‚æ–‡æ¡£çš„æ–¹æ³•
          const openProjectDoc = () => {
            if (!form.projectName) {
              ElMessage({
                message: "è¯·å…ˆé€‰æ‹©é¡¹ç›®åç§°",
                type: "warning",
              });
              return;
            }

            const docUrl = getProjectDocUrl(form.projectName);
            if (docUrl) {
              // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€éœ€æ±‚æ–‡æ¡£
              window.open(docUrl, "_blank");
              console.log(
                `åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ ${form.projectName} éœ€æ±‚æ–‡æ¡£:`,
                docUrl
              );
            } else {
              ElMessage({
                message: `æœªæ‰¾åˆ° ${form.projectName} çš„éœ€æ±‚æ–‡æ¡£`,
                type: "warning",
              });
            }
          };

          const handleFileChangeExcel = () => {
            if (!form.id) {
              ElMessage({
                message: "Please enter the activity id.",
                type: "error",
              });
              return;
            }
            excelInput.value?.click();
          };

          const excelInput = ref(null);

          function excelInputChange(event) {
            if (event.target.value.toUpperCase().endsWith("XLSX")) {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = async function (e) {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, { type: "array" });

                  // å‡è®¾ Excel ä¸­åªæœ‰ä¸€ä¸ªè¡¨æ ¼ï¼Œå–ç¬¬ä¸€ä¸ªè¡¨æ ¼
                  const sheetName = workbook.SheetNames[0];
                  const sheet = workbook.Sheets[sheetName];

                  const columnData = {};
                  // è§£æè¡¨æ ¼ä¸­çš„æ•°æ®
                  for (const cellAddress in sheet) {
                    if (
                      cellAddress[0] === "!" ||
                      !sheet.hasOwnProperty(cellAddress)
                    )
                      continue;

                    const cell = sheet[cellAddress];
                    const columnName = cellAddress.match(/[A-Z]+/)[0]; // è·å–åˆ—å
                    const cellValue = cell.v;

                    if (!columnData[columnName]) {
                      columnData[columnName] = [];
                    }

                    columnData[columnName].push({
                      content: cellValue,
                      index: cellAddress.slice(1),
                    });
                  }

                  for (const columnName in columnData) {
                    const columnValues = columnData[columnName];
                    const _area = columnValues[0].content.replace(
                      /[\u4e00-\u9fa5\s]/g,
                      ""
                    );
                    console.log(_area, "_area");
                    const data = {
                      activityId: form.id,
                      area: ["Arabic", "XM", "EG"].includes(_area)
                        ? "ME"
                        : ["Chinese", "CN"].includes(_area)
                        ? "TW"
                        : _area,
                      content: `{"list":${JSON.stringify(columnValues)}}`,
                      count: columnValues.length,
                      operator: "stone@micous.com",
                    };

                    await upload(data);
                  }

                  // æ¸…ç©º input çš„ valueï¼Œç¡®ä¿ä¸‹æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶æ—¶ä¹Ÿèƒ½è§¦å‘ change äº‹ä»¶
                  event.target.value = "";
                };
                reader.readAsArrayBuffer(file);
              }
            }
          }

          const upload = async (data) => {
            if (["ENGLISH", "NOTE", "EN", "EVENTTITLE"].includes(data.area))
              return;

            // form.name ä¸­é¦–å­—æ¯å°å†™å¹¶å»é™¤ç©ºæ ¼
            data.name = data.name
              ?.replace(/\s+/g, "")
              ?.replace(/^[A-Z]/, (match) => match.toLowerCase());

            const url =
              form.projectName == "Hiyoo"
                ? "http://localhost:3000/sendHiyoo"
                : "http://localhost:3000/send";

            await axios.post(url, data).then((res) => {
              if (res.data.data.code == 1) {
                console.log(`Congrats, ${data.area} text have uploaded.`);
                ElMessage({
                  message: `Congrats, ${data.area} text have uploaded.`,
                  type: "success",
                });
              } else {
                console.log(`Error, ${data.area} text hava error.`);
                ElMessage({
                  message: `Error, ${data.area} text hava error.`,
                  type: "warning",
                });
              }
            });
          };

          return {
            form,
            onSubmit,
            handleInfo,
            handleFileChange,
            handleFileChangeExcel,
            openProjectDoc,
            updateBase,
            uploadLoading,
            downloadLoading,
            downloadTemplate,
            upload,
            excelInputChange,
            excelInput,
          };
        },
      };

      const app = createApp(App);
      app.use(ElementPlus);
      app.mount("#app");
    </script>
  </body>
</html>
